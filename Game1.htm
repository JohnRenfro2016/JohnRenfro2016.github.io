<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Advanced Dungeons & Dragons 1st Edition</title>
<style>
body,button,input,radio,text,textArea,a:link,a:visited {
background-color:#24505d;
border-color:#000;
border-style:solid;
border-width:2px;
color:#b6d9e3;
}

table,tr,td {
background-color:#2b606f;
border-color:#3a8094;
color:#ecf5f8;
}

.board.touch,.unit.touch {
touch-action:none;
}

.board {
border-style:solid;
color:inherit;
display:grid;
grid-template-columns:repeat(7,100px);
grid-template-rows:repeat(7,100px);
height:700px;
max-height: 700px;
max-width: 700px;
position:relative;
width:700px;
}

.menu {
position:relative;
max-width:none;
}

.menu-button {
cursor:pointer;
display:inline-block;
font-size:10px;
}

.menu-input {
color:#b6d9e3;
display:inline-block;
box-sizing:border-box;
font-size:10px;
max-height: 100px;
max-width: 100px;
z-index:3;
}

.menu-item {
color:#c8e2ea;
display:inline-block;
text-shadow:-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000,1px 1px 0 #000;
}

.unit-display {
float:right;
position:absolute;
bottom:0;
right:0;
clear:right;
}

.rotate-button {
display:inline-block;
font-size:10px;
}

.square {
width:100px;
height:100px;
border:1px solid #000;
}

#board {
position:relative;
width:700px;
height:700px;
border:1px solid #000;
}

.unit {
background-color:#000;
color:black;
cursor:move;
font-size:10px;
height:100px;
position:absolute;
transform-origin:center;
user-select:none;
width:100px;
z-index:1;
}

.unit img {
position:absolute;
}

</style>
</head>
<body>
<table><tr><td>
<a href='https://archive.org/details/tsr02011advanceddungeonsdragonsadd1steddungeonmastersguide/page/n74/mode/1up' target='_blank'>1st Edition Dungeon Masters Guide Combat Tables</a>
<a href='https://archive.org/details/tsr02009addmonstermanual/mode/1up' target='_blank'>1st Edition Monster Manual</a>
<a href='https://archive.org/details/tsr09045addthesecretofbonehill/mode/1up' target='_blank'>Dungeon Module L1 "The Secret of Bone Hill</a>

<button onclick="createUnit()">Create a character or monster?</button>

Load a map image.
<input type="file" id="mapImageInput" accept="image/*">

<button id="rollD20Button">Roll D20</button>
<button id="rollD12Button">Roll D12</button>
<button id="rollD10Button">Roll D10</button>
<button id="rollD8Button">Roll D8</button>
<button id="rollD6Button">Roll D6</button>
<button id="rollD4Button">Roll D4</button>

<div id="resultsContainer"></div>
</td></tr><tr><td>

<div class="board" id="board"></div>

</td></tr></table>

<script>
let unitCount=0;
let highestZIndex=1;

// Start constant declarations
const board=document.getElementById('board');
for (let i=0; i < 49; i++) {
const square=document.createElement('div');
square.className='square';
board.appendChild(square);
}
// End constant declarations

// start of drag functions

let isDragging = false;
let draggedElement = null;
let offsetX, offsetY;

document.addEventListener('mousedown', onMouseDown);
document.addEventListener('mousemove', onMouseMove);
document.addEventListener('mouseup', onMouseUp);

function onMouseDown(event) {
    if (event.target.classList.contains('unit')) {
        isDragging = true;
        draggedElement = event.target;
        offsetX = event.clientX - draggedElement.offsetLeft;
        offsetY = event.clientY - draggedElement.offsetTop;
        draggedElement.style.zIndex = '2'; // Bring the element to the top
        document.addEventListener('selectstart', preventDefault); // Prevent text selection during drag
    }
}

function onMouseMove(event) {
    if (isDragging) {
        event.preventDefault();
        const mouseX = event.clientX - offsetX;
        const mouseY = event.clientY - offsetY;
        draggedElement.style.left = `${mouseX}px`;
        draggedElement.style.top = `${mouseY}px`;
    }
}

function onMouseUp() {
    if (isDragging) {
        isDragging = false;
        draggedElement.style.zIndex = '1'; // Restore the z-index
        document.removeEventListener('selectstart', preventDefault);
    }
}

function preventDefault(event) {
    event.preventDefault();
}

// End of the drag functions

const lastRolls=[];

// Function to display the last 5 rolls on the webpage
function displayLastRolls() {
const resultsContainer=document.getElementById('resultsContainer');
resultsContainer.innerHTML=lastRolls.join('<br>');
}

// Function to roll a random 20-sided die (D20)
function rollD20() {
const result=Math.floor(Math.random() * 20) + 1;
lastRolls.push(`D20 Result:${result}`);
if (lastRolls.length > 5) {
lastRolls.shift(); // Remove the oldest roll
}
displayLastRolls();
}

// Function to roll a 12-sided die (D12)
function rollD12() {
const result=Math.floor(Math.random() * 12) + 1;
lastRolls.push(`D12 Result:${result}`);
if (lastRolls.length > 5) {
lastRolls.shift(); // Remove the oldest roll
}
displayLastRolls();
}

// Function to roll a 10-sided die (D10)
function rollD10() {
const result=Math.floor(Math.random() * 10) + 1;
lastRolls.push(`D10 Result:${result}`);
if (lastRolls.length > 5) {
lastRolls.shift(); // Remove the oldest roll
}
displayLastRolls();
}

// Function to roll an 8-sided die (D8)
function rollD8() {
const result=Math.floor(Math.random() * 8) + 1;
lastRolls.push(`D8 Result:${result}`);
if (lastRolls.length > 5) {
lastRolls.shift(); // Remove the oldest roll
}
displayLastRolls();
}

// Function to roll a 6-sided die (D6)
function rollD6() {
const result=Math.floor(Math.random() * 6) + 1;
lastRolls.push(`D6 Result:${result}`);
if (lastRolls.length > 5) {
lastRolls.shift(); // Remove the oldest roll
}
displayLastRolls();
}

// Function to roll a 4-sided die (D4)
function rollD4() {
const result=Math.floor(Math.random() * 4) + 1;
lastRolls.push(`D4 Result:${result}`);
if (lastRolls.length > 5) {
lastRolls.shift(); // Remove the oldest roll
}
displayLastRolls();
}

// Event listeners for rolling each die
document.addEventListener('DOMContentLoaded',function() {
document.getElementById('rollD20Button').addEventListener('click',rollD20);
document.getElementById('rollD12Button').addEventListener('click',rollD12);
document.getElementById('rollD10Button').addEventListener('click',rollD10);
document.getElementById('rollD8Button').addEventListener('click',rollD8);
document.getElementById('rollD6Button').addEventListener('click',rollD6);
document.getElementById('rollD4Button').addEventListener('click',rollD4);
});

// Beginning of map image loading functions
let currentMapImage='Map.png';

function loadMapImage(event) {
const mapImage=document.createElement('img');
const file=event.target.files[0];

if (file) {
currentMapImage=URL.createObjectURL(file);
mapImage.src=currentMapImage;
mapImage.style.position='absolute';
mapImage.style.width='100%';
mapImage.style.height='100%';
mapImage.style.top='0';
mapImage.style.left='0';
mapImage.style.zIndex='-1';
const board=document.getElementById('board');
board.innerHTML='';
board.appendChild(mapImage);
changeMap();
}
}

document.getElementById('mapImageInput').addEventListener('change',loadMapImage);

const defaultMapImage=new Image();
defaultMapImage.src='Map.png';

defaultMapImage.onload=function() {
const board=document.getElementById('board');
board.style.backgroundImage=`url(${defaultMapImage.src})`;
board.style.backgroundSize='cover';
}

function changeMap() {
const board=document.getElementById('board');
board.style.backgroundImage=`url(${currentMapImage})`;
board.style.backgroundSize='cover';
}
// End of map image loading functions

function getRotationDegrees(element) {
const transform=window.getComputedStyle(element).getPropertyValue('transform');
if (transform && transform !== 'none') {
const matrix=new DOMMatrix(transform);
return Math.round(Math.atan2(matrix.b,matrix.a) * (180/Math.PI));
}
return 0;
}

// Start drag and drop functions
function onDragStart(event) {
isDragging=true;
event.dataTransfer.setData('text/plain',event.target.id);

const rect=event.target.getBoundingClientRect();
offsetX=event.clientX - rect.left;
offsetY=event.clientY - rect.top;
draggedElement=event.target;

highestZIndex++;
draggedElement.style.zIndex=highestZIndex;
}

function onDragOver(event) {
event.preventDefault();
}

function onDrop(event) {
event.preventDefault();
const data=event.dataTransfer.getData('text/plain');
const draggedElement=document.getElementById(data);
const cellSize=100;

if (draggedElement) {
const mouseX=event.clientX - board.offsetLeft;
const mouseY=event.clientY - board.offsetTop;

const cellX=Math.floor(mouseX / cellSize) * cellSize;
const cellY=Math.floor(mouseY / cellSize) * cellSize;

draggedElement.style.left=`${cellX}px`;
draggedElement.style.top=`${cellY}px`;
}
}

board.addEventListener('dragover',(event) => {
event.preventDefault();
});

board.addEventListener('drop',(event) => {
event.preventDefault();
const data=event.dataTransfer.getData('text/plain');
const draggedElement=document.getElementById(data);
const cellSize=100;

if (draggedElement) {
const mouseX=event.clientX - board.offsetLeft;
const mouseY=event.clientY - board.offsetTop;

const cellX=Math.floor(mouseX / cellSize) * cellSize;
const cellY=Math.floor(mouseY / cellSize) * cellSize;

draggedElement.style.left=`${cellX}px`;
draggedElement.style.top=`${cellY}px`;
}
});

document.addEventListener('mousemove',onMouseMove);

function onMouseMove(event) {
if (isDragging) {
const mouseX=event.clientX - offsetX + window.scrollX;
const mouseY=event.clientY - offsetY + window.scrollY;
const boardRect=board.getBoundingClientRect();
const maxX=boardRect.width - draggedElement.offsetWidth;
const maxY=boardRect.height - draggedElement.offsetHeight;
const newX=Math.min(Math.max(0,mouseX),maxX);
const newY=Math.min(Math.max(0,mouseY),maxY);
draggedElement.style.left=`${newX}px`;
draggedElement.style.top=`${newY}px`;
}
}

document.addEventListener('mouseup',onMouseUp);

function onMouseUp() {
if (isDragging) {
isDragging=false;
}
}

document.addEventListener('dragend',() => {
isDragging=false;
draggedElement=null;
});
// End drag and drop functions

function createUnit() {
const unitElement=document.createElement('div');
unitElement.className='unit';
unitElement.draggable=true;
unitElement.id=`unit-${unitCount}`;
unitElement.ondragstart=onDragStart;

const rotateButton=document.createElement('button');
rotateButton.textContent='R';
rotateButton.className='rotate-button';

rotateButton.addEventListener('click',function(event) {
event.stopPropagation(); // Stop event from bubbling up
let currentRotation=0;

const transform=unitElement.style.transform;
const match=transform && transform.match(/\d+/);

if (match) {
currentRotation=parseInt(match[0],10);
}
unitElement.style.transform=`rotate(${(currentRotation + 45) % 360}deg)`;
});

const menuButton=document.createElement('button');
menuButton.className='menu-button';
menuButton.textContent='M';

const menu=document.createElement('div');
menu.className='menu';

const nameLabel=document.createElement('div');
nameLabel.className='menu-item';
nameLabel.textContent='Name:';

const nameInput=document.createElement('input');
nameInput.type='text';
nameInput.className='menu-input';
nameInput.placeholder='character or monster name';
nameInput.maxLength=9;
nameInput.size=9;
nameInput.style.width='10em';
nameInput.addEventListener('input',function() {
nameUnit.textContent=nameInput.value;
});

const addImageButton=Object.assign(document.createElement('button'),{
className:'menu-button',
textContent:'Add a miniature?',
onclick:function() {
imageInput.click();
}
});

const imageInput=Object.assign(document.createElement('input'),{
type:'file',
accept:'image/*',
style:'display:none;'
});

imageInput.addEventListener('change',function() {
const file=this.files[0];
const reader=new FileReader();

reader.onload=function() {
const imageElement=document.createElement('img');
imageElement.src=reader.result;

// Add an event listener to the image to prevent dragging
imageElement.addEventListener('dragstart',function(event) {
event.preventDefault();
});

unitElement.style.backgroundImage=`url(${reader.result})`; // Set image as background

// Remove the added image element
imageElement.remove();
}

reader.readAsDataURL(file);
});

const movementLabel=document.createElement('div');
movementLabel.className='menu-item';
movementLabel.textContent='MV:';
const movementInput=document.createElement('input');
movementInput.className='menu-input';
movementInput.maxLength=2;
movementInput.size=2;
movementInput.style.width='3em';
movementInput.type='text';

const armorClassLabel=document.createElement('div');
armorClassLabel.className='menu-item';
armorClassLabel.textContent='AC:';
const armorClassInput=document.createElement('input');
armorClassInput.className='menu-input';
armorClassInput.maxLength=2;
armorClassInput.size=2;
armorClassInput.style.width='3em';
armorClassInput.type='text';
armorClassInput.addEventListener('input',function() {
unitElement.dataset.ac=armorClassInput.value;
armorClassUnit.textContent=`AC:${armorClassInput.value}`;
});
const armorClassUnit=document.createElement('div');
armorClassUnit.className='menu-item';
armorClassUnit.textContent='AC:';

const hitDiceLabel=document.createElement('div');
hitDiceLabel.className='menu-item';
hitDiceLabel.textContent='HD:';
const hitDiceInput=document.createElement('input');
hitDiceInput.className='menu-input';
hitDiceInput.maxLength=8;
hitDiceInput.size=8;
hitDiceInput.style.width='9em';
hitDiceInput.type='text';

const maximumHitPointsLabel=document.createElement('div');
maximumHitPointsLabel.className='menu-item';
maximumHitPointsLabel.textContent='maxHP:';
const maximumHitPointsInput=Object.assign(
document.createElement('input'),
{
className:'menu-input',
maxLength:3,
size:3,
style:'width:4em;',
type:'text',
oninput:function() {
currentHitPointsInput.value=this.value;
currentHitPointsUnit.textContent=`HP:${this.value}`;
}
}
);

const currentHitPointsLabel=document.createElement('div');
currentHitPointsLabel.className='menu-item';
currentHitPointsLabel.textContent='curHP:';
const currentHitPointsInput=document.createElement('input');
currentHitPointsInput.className='menu-input';
currentHitPointsInput.maxLength=3;
currentHitPointsInput.size=3;
currentHitPointsInput.style.width='4em';
currentHitPointsInput.type='text';
const currentHitPointsUnit=document.createElement('div');
currentHitPointsUnit.className='menu-item';
currentHitPointsUnit.textContent='HP:';
currentHitPointsInput.addEventListener('input',
function() {
unitElement.dataset.curHP=currentHitPointsInput.value;
currentHitPointsUnit.textContent=`HP:${currentHitPointsInput.value}`;
});

const menuAddRowButton=document.createElement('button');
menuAddRowButton.className='menu-button';
menuAddRowButton.textContent='Add a weapon or spell and effect?';

menuAddRowButton.addEventListener('click',function() {
const newRow=document.createElement('div');
newRow.className='menu-item';

const newAttackName=document.createElement('input');
newAttackName.type='text';
newAttackName.className='menu-input';
newAttackName.placeholder='weapon or spell name and effect';
newAttackName.maxLength=9;
newAttackName.size=9;
newAttackName.style.width='10em';
newRow.appendChild(newAttackName);

const newAttackRoll=document.createElement('input');
newAttackRoll.type='text';
newAttackRoll.className='menu-input';
newAttackRoll.placeholder='Attack Roll';
newAttackRoll.maxLength=8;
newAttackRoll.size=8;
newAttackRoll.style.width='9em';
newRow.appendChild(newAttackRoll);

const newDamageRoll=document.createElement('input');
newDamageRoll.type='text';
newDamageRoll.className='menu-input';
newDamageRoll.placeholder='Damage Roll';
newDamageRoll.maxLength=8;
newDamageRoll.size=8;
newDamageRoll.style.width='9em';
newRow.appendChild(newDamageRoll);

menu.insertBefore(newRow,menuAddRowButton);
});

const deleteButton=document.createElement('button');
deleteButton.className='menu-button';
deleteButton.textContent='Delete this piece?';
deleteButton.addEventListener('click',function() {
menu.remove();
unitElement.remove();
});

menuButton.addEventListener('click',function(event) {
event.stopPropagation();
menu.style.display='inline-block';
});

document.addEventListener('click',function() {
//menu.style.display='none';
});

menu.addEventListener('click',function(event) {
event.stopPropagation();
});

movementInput.addEventListener('input',function() {
unitElement.dataset.mv=movementInput.value;
movementUnit.textContent=`MV:${movementInput.value}`;
});

hitDiceInput.addEventListener('input',function() {
unitElement.dataset.hd=hitDiceInput.value;
hitDiceUnit.textContent=`HD:${hitDiceInput.value}`;
});

const nameUnit=document.createElement('div');
nameUnit.className='menu-item';
nameUnit.textContent='Name';

const movementUnit=document.createElement('div');
movementUnit.className='menu-item';
movementUnit.textContent='MV:';

movementInput.addEventListener('input',function() {
unitElement.dataset.mv=movementInput.value;
movementUnit.textContent=`MV:${movementInput.value}`;
});

const hitDiceUnit=document.createElement('div');
hitDiceUnit.className='menu-item';
hitDiceUnit.textContent='HD:';

hitDiceInput.addEventListener('input',function() {
unitElement.dataset.hd=hitDiceInput.value;
hitDiceUnit.textContent=`HD:${hitDiceInput.value}`;
});

unitElement.appendChild(rotateButton);
unitElement.style.left='0';
unitElement.style.top='0';
unitElement.appendChild(armorClassUnit);
unitElement.appendChild(hitDiceUnit);
unitElement.appendChild(currentHitPointsUnit);
unitElement.appendChild(movementUnit);
unitElement.appendChild(nameUnit);

board.appendChild(unitElement);

menu.appendChild(nameLabel);
menu.appendChild(nameInput);
menu.appendChild(addImageButton);
menu.appendChild(imageInput);
menu.appendChild(armorClassLabel);
menu.appendChild(armorClassInput);
menu.appendChild(hitDiceLabel);
menu.appendChild(hitDiceInput);
menu.appendChild(maximumHitPointsLabel);
menu.appendChild(maximumHitPointsInput);
menu.appendChild(currentHitPointsLabel);
menu.appendChild(currentHitPointsInput);
menu.appendChild(movementLabel);
menu.appendChild(movementInput);
menu.appendChild(menuAddRowButton);

menu.appendChild(deleteButton);

document.body.appendChild(menu);

unitCount++;
}
</script>
</body>
</html>
